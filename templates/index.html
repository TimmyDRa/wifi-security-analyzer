{% extends "base.html" %}

{% block page_header %}
<div class="page-title">
  <span style="font-size: 1.5rem;">üè†</span>
  <h2>Dashboard Overview</h2>
</div>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">üöÄ Welcome to WiFi Security Analyzer</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-8">
        <p class="lead mb-3">
          Your comprehensive network security toolkit for WiFi analysis, vulnerability scanning, and threat detection.
        </p>
        <p class="mb-3">
          This powerful tool helps you monitor wireless networks, detect security threats, and perform comprehensive vulnerability assessments. Perfect for security professionals, network administrators, and researchers.
        </p>
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('wifi') }}" class="btn btn-primary">
            üì∂ Start WiFi Scan
          </a>
          <a href="{{ url_for('vuln') }}" class="btn btn-warning">
            üîç Quick Security Check
          </a>
          <a href="{{ url_for('sniffer_page') }}" class="btn btn-success">
            üì° Launch Sniffer
          </a>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <div class="stats-card">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üõ°Ô∏è</div>
          <h5>Security First</h5>
          <p class="text-muted mb-0">Advanced threat detection and real-time monitoring</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Stats Dashboard -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card h-100">
      <div class="card-body text-center stats-card">
        <div style="font-size: 2.5rem; color: var(--primary-blue); margin-bottom: 0.5rem;">üìä</div>
        <h4 id="totalAlerts" class="text-primary-blue">0</h4>
        <small class="text-muted">Total Alerts</small>
        <div class="mt-2">
          <a href="{{ url_for('alerts') }}" class="btn btn-sm btn-outline-primary">View Details</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card h-100">
      <div class="card-body text-center stats-card">
        <div style="font-size: 2.5rem; color: var(--success); margin-bottom: 0.5rem;">üì°</div>
        <h4 id="snifferStatus" class="text-success">Offline</h4>
        <small class="text-muted">Packet Sniffer</small>
        <div class="mt-2">
          <a href="{{ url_for('sniffer_page') }}" class="btn btn-sm btn-outline-success">Configure</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card h-100">
      <div class="card-body text-center stats-card">
        <div style="font-size: 2.5rem; color: var(--warning); margin-bottom: 0.5rem;">üìß</div>
        <h4 id="emailStatus" class="text-warning">Unknown</h4>
        <small class="text-muted">Email Alerts</small>
        <div class="mt-2">
          <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-warning">Setup</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="card h-100">
      <div class="card-body text-center stats-card">
        <div style="font-size: 2.5rem; color: var(--primary-red); margin-bottom: 0.5rem;">üîç</div>
        <h4 id="lastScanTime" class="text-primary-red">Never</h4>
        <small class="text-muted">Last Scan</small>
        <div class="mt-2">
          <a href="{{ url_for('vuln') }}" class="btn btn-sm btn-outline-danger">Run Scan</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Feature Overview -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card h-100">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0">üîß Core Features</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
            <ul class="list-unstyled">
              <li class="mb-2">
                <span class="badge bg-primary-blue me-2">WiFi</span>
                Network Discovery
              </li>
              <li class="mb-2">
                <span class="badge bg-success me-2">Monitor</span>
                Real-time Sniffing
              </li>
              <li class="mb-2">
                <span class="badge bg-warning me-2">Scan</span>
                Vulnerability Assessment
              </li>
            </ul>
          </div>
          <div class="col-sm-6">
            <ul class="list-unstyled">
              <li class="mb-2">
                <span class="badge bg-primary-red me-2">Detect</span>
                Intrusion Detection
              </li>
              <li class="mb-2">
                <span class="badge bg-info me-2">Alert</span>
                Email Notifications
              </li>
              <li class="mb-2">
                <span class="badge bg-secondary me-2">Log</span>
                Activity Logging
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6 mb-3">
    <div class="card h-100">
      <div class="card-header bg-warning text-white">
        <h6 class="mb-0">‚ö†Ô∏è Important Security Notes</h6>
      </div>
      <div class="card-body">
        <div class="alert alert-warning mb-2">
          <small><strong>Legal Compliance:</strong> Only scan networks you own or have explicit permission to test</small>
        </div>
        <div class="alert alert-info mb-2">
          <small><strong>Root Access:</strong> Packet sniffing requires administrator privileges</small>
        </div>
        <div class="alert alert-danger mb-0">
          <small><strong>Privacy:</strong> Handle captured data responsibly and securely</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <h6 class="mb-0">‚ö° Quick Actions</h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3 mb-2">
        <button class="btn btn-outline-primary w-100" onclick="quickWiFiScan()">
          <div class="d-flex align-items-center justify-content-center">
            <span class="me-2">üì∂</span>
            <div class="text-start">
              <div>WiFi Scan</div>
              <small class="text-muted">Discover networks</small>
            </div>
          </div>
        </button>
      </div>
      
      <div class="col-md-3 mb-2">
        <button class="btn btn-outline-success w-100" onclick="quickPortScan()">
          <div class="d-flex align-items-center justify-content-center">
            <span class="me-2">üöÄ</span>
            <div class="text-start">
              <div>Quick Scan</div>
              <small class="text-muted">Port scan localhost</small>
            </div>
          </div>
        </button>
      </div>
      
      <div class="col-md-3 mb-2">
        <button class="btn btn-outline-warning w-100" onclick="testEmailSystem()">
          <div class="d-flex align-items-center justify-content-center">
            <span class="me-2">üìß</span>
            <div class="text-start">
              <div>Test Email</div>
              <small class="text-muted">Verify alerts</small>
            </div>
          </div>
        </button>
      </div>
      
      <div class="col-md-3 mb-2">
        <button class="btn btn-outline-info w-100" onclick="systemHealthCheck()">
          <div class="d-flex align-items-center justify-content-center">
            <span class="me-2">üîß</span>
            <div class="text-start">
              <div>System Check</div>
              <small class="text-muted">Health status</small>
            </div>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity -->
<div class="card">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h6 class="mb-0">üìã Recent Activity</h6>
    <a href="{{ url_for('alerts') }}" class="btn btn-sm btn-outline-light">View All</a>
  </div>
  <div class="card-body">
    <div id="recentActivity">
      <div class="text-center text-muted py-4">
        <div style="font-size: 2rem; opacity: 0.5;">üìä</div>
        <p>Loading recent activity...</p>
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Help -->
<div class="modal fade" id="shortcutsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">‚å®Ô∏è Keyboard Shortcuts</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-6">
            <h6>Navigation</h6>
            <ul class="list-unstyled">
              <li><kbd>Ctrl</kbd> + <kbd>H</kbd> - Home</li>
              <li><kbd>Ctrl</kbd> + <kbd>W</kbd> - WiFi Scan</li>
              <li><kbd>Ctrl</kbd> + <kbd>A</kbd> - Alerts</li>
            </ul>
          </div>
          <div class="col-6">
            <h6>Actions</h6>
            <ul class="list-unstyled">
              <li><kbd>Ctrl</kbd> + <kbd>V</kbd> - Vuln Scan</li>
              <li><kbd>Ctrl</kbd> + <kbd>S</kbd> - Sniffer</li>
              <li><kbd>F1</kbd> - Help (this dialog)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Quick action functions
  function quickWiFiScan() {
    showNotification('Starting WiFi scan...', 'info');
    setTimeout(() => {
      window.location.href = "{{ url_for('wifi') }}";
    }, 1000);
  }

  function quickPortScan() {
    showNotification('Initiating quick port scan...', 'info');
    
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/quick-scan';
    form.style.display = 'none';
    
    const targetInput = document.createElement('input');
    targetInput.name = 'target';
    targetInput.value = '127.0.0.1';
    form.appendChild(targetInput);
    
    document.body.appendChild(form);
    form.submit();
  }

  function testEmailSystem() {
    showNotification('Testing email system...', 'info');
    
    fetch('/email-test', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Email test successful!', 'success');
        } else {
          showNotification(`Email test failed: ${data.message}`, 'danger');
        }
      })
      .catch(error => {
        showNotification('Email test error - check console', 'danger');
        console.error('Email test error:', error);
      });
  }

  function systemHealthCheck() {
    showNotification('Running system health check...', 'info');
    
    fetch('/system-status')
      .then(response => response.json())
      .then(data => {
        let issues = 0;
        let message = 'System health check completed:\n';
        
        if (data.sniffer && !data.sniffer.can_sniff) {
          issues++;
          message += `‚Ä¢ Sniffer: ${data.sniffer.issues.join(', ')}\n`;
        }
        
        if (data.email && !data.email.can_connect) {
          issues++;
          message += `‚Ä¢ Email: ${data.email.connection_message}\n`;
        }
        
        if (issues === 0) {
          showNotification('‚úÖ System health check: All systems operational!', 'success');
        } else {
          showNotification(`‚ö†Ô∏è System health check: ${issues} issue(s) found. Check alerts for details.`, 'warning');
        }
      })
      .catch(error => {
        showNotification('Health check failed - check console', 'danger');
        console.error('Health check error:', error);
      });
  }

  // Load dashboard data
  function loadDashboardData() {
    // Load stats
    fetch('/stats')
      .then(response => response.json())
      .then(data => {
        const totalAlerts = Object.values(data).reduce((sum, count) => 
          sum + (typeof count === 'number' ? count : 0), 0);
        document.getElementById('totalAlerts').textContent = totalAlerts || '0';
      })
      .catch(error => console.log('Stats load failed:', error));

    // Load system status
    fetch('/system-status')
      .then(response => response.json())
      .then(data => {
        // Update sniffer status
        const snifferEl = document.getElementById('snifferStatus');
        if (data.sniffer && data.sniffer.can_sniff) {
          snifferEl.textContent = 'Ready';
          snifferEl.className = 'text-success';
        } else {
          snifferEl.textContent = 'Issues';
          snifferEl.className = 'text-warning';
        }
        
        // Update email status
        const emailEl = document.getElementById('emailStatus');
        if (data.email && data.email.can_connect) {
          emailEl.textContent = 'Working';
          emailEl.className = 'text-success';
        } else if (data.email && data.email.enabled) {
          emailEl.textContent = 'Failed';
          emailEl.className = 'text-danger';
        } else {
          emailEl.textContent = 'Disabled';
          emailEl.className = 'text-secondary';
        }
      })
      .catch(error => console.log('System status load failed:', error));

    // Load recent activity
    fetch('/alerts')
      .then(response => response.text())
      .then(html => {
        // Extract alerts from the HTML (basic parsing)
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const alerts = doc.querySelectorAll('.alert-secondary');
        
        const recentActivityDiv = document.getElementById('recentActivity');
        
        if (alerts.length === 0) {
          recentActivityDiv.innerHTML = `
            <div class="text-center text-muted py-4">
              <div style="font-size: 2rem; opacity: 0.5;">üì≠</div>
              <p>No recent activity</p>
              <small>Try running a WiFi scan or vulnerability assessment to generate some alerts</small>
            </div>
          `;
        } else {
          recentActivityDiv.innerHTML = '<div class="list-group list-group-flush"></div>';
          const listGroup = recentActivityDiv.querySelector('.list-group');
          
          // Show last 5 alerts
          Array.from(alerts).slice(0, 5).forEach((alert, index) => {
            const alertText = alert.textContent.trim();
            const timeMatch = alertText.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/);
            const time = timeMatch ? timeMatch[0] : 'Unknown time';
            const message = alertText.replace(time, '').replace(/^\s*-\s*/, '');
            
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item list-group-item-action';
            listItem.innerHTML = `
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${message}</h6>
                <small>${time}</small>
              </div>
            `;
            listGroup.appendChild(listItem);
          });
        }
      })
      .catch(error => {
        document.getElementById('recentActivity').innerHTML = `
          <div class="alert alert-warning">
            <small>Unable to load recent activity</small>
          </div>
        `;
      });
  }

  // Keyboard shortcut for help
  document.addEventListener('keydown', function(e) {
    if (e.key === 'F1') {
      e.preventDefault();
      new bootstrap.Modal(document.getElementById('shortcutsModal')).show();
    }
  });

  // Initialize dashboard
  document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Refresh data every 30 seconds
    setInterval(loadDashboardData, 30000);
  });
</script>
{% endblock %}